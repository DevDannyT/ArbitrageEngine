<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Flip Radar Results</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="wrap">
    <a class="back" href="/">← New search</a>
    <h1>Flip Radar</h1>

    <div class="card">
      <div class="meta"><strong>Query:</strong> {{ q }}</div>
      <div class="meta"><strong>Market query:</strong> {{ market_query }}</div>

      <div class="meta2">
        Sold comps used: {{ sold_count_used }} |
        Median: {{ sold_stats.median }} |
        IQR: {{ sold_stats.iqr }} |
        Min/Max: {{ sold_stats.min }} / {{ sold_stats.max }}
      </div>

      <div class="meta2">
        Filters:
        confidence ≥ {{ min_confidence }},
        discount ≥ {{ (min_discount*100) | round(0) }}%,
        profit ≥ ${{ min_profit_usd }}
      </div>
    </div>

    <div class="card">
      <h2>Undervalued live listings</h2>

      {% if not ranked %}
        <div class="muted">
          No hits with current filters. Try:
          - adding set name / card number
          - lowering MIN_DISCOUNT or MIN_PROFIT_USD in .env
        </div>
      {% endif %}

      {% for r in ranked[:25] %}
        <div class="opp">
          <div class="oppTop">
            <div class="oppTitle">
              <a href="{{ r.item.itemWebUrl }}" target="_blank">{{ r.item.title }}</a>
            </div>
            <div class="pill">Score {{ "%.2f"|format(r.score) }}</div>
          </div>

          <div class="oppGrid">
            <div>
              <div class="k">Live Total</div>
              <div class="v">
                ${{ "%.2f"|format(r.economics.buy_total) }}
              </div>
            </div>
            <div>
              <div class="k">Sold Median</div>
              <div class="v">${{ "%.2f"|format(r.economics.sold_median) }}</div>
            </div>
            <div>
              <div class="k">Discount</div>
              <div class="v">{{ "%.1f"|format(r.discount * 100) }}%</div>
            </div>
            <div>
              <div class="k">Profit</div>
              <div class="v">${{ "%.2f"|format(r.economics.profit) }}</div>
            </div>
            <div>
              <div class="k">Confidence</div>
              <div class="v">{{ "%.2f"|format(r.match.confidence) }}</div>
            </div>
          </div>

          <details class="details">
            <summary>Why it matched</summary>
            <ul>
              {% for rr in r.match.reasons %}
                <li>
                  <span class="{{ 'ok' if rr.ok else 'bad' }}">
                    {{ rr.signal }}:
                    {% if rr.value is defined %}{{ rr.value }}{% endif %}
                    {% if rr.hits is defined %} ({{ rr.hits }}/{{ rr.total }}){% endif %}
                    {% if rr.ok %} ✅{% else %} ❌{% endif %}
                  </span>
                </li>
              {% endfor %}
            </ul>
          </details>
        </div>
      {% endfor %}
    </div>

  </div>
</body>
</html>
